# Marketing Agent Swarm - Docker Compose
# 8 autonomous marketing agents with shared volumes


services:
  # ============================================================================
  # Orchestrator - Runs the pipeline and coordinates all agents
  # ============================================================================
  orchestrator:
    build:
      context: .
    container_name: marketing-orchestrator
    command: ["npx", "tsx", "agents/orchestrator/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - DRY_RUN=${DRY_RUN:-true}
      - PUBLISH_ENABLED=${PUBLISH_ENABLED:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
      # Platform credentials (from .env)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_OWNER=${GITHUB_OWNER:-}
      - GITHUB_REPO=${GITHUB_REPO:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHANNEL_ID=${TELEGRAM_CHANNEL_ID:-}
      - X_API_KEY=${X_API_KEY:-}
      - X_API_SECRET=${X_API_SECRET:-}
      - X_ACCESS_TOKEN=${X_ACCESS_TOKEN:-}
      - X_ACCESS_SECRET=${X_ACCESS_SECRET:-}
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - REDDIT_USERNAME=${REDDIT_USERNAME:-}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD:-}
      - REDDIT_SUBREDDIT=${REDDIT_SUBREDDIT:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Strategy - Generates daily briefs and content calendar
  # ============================================================================
  strategy:
    build:
      context: .
      
    container_name: marketing-strategy
    command: ["npx", "tsx", "agents/strategy/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Content - Generates marketing content drafts
  # ============================================================================
  content:
    build:
      context: .
      
    container_name: marketing-content
    command: ["npx", "tsx", "agents/content/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Distribution - Publishes approved content to platforms
  # ============================================================================
  distribution:
    build:
      context: .
      
    container_name: marketing-distribution
    command: ["npx", "tsx", "agents/distribution/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - DRY_RUN=${DRY_RUN:-true}
      - PUBLISH_ENABLED=${PUBLISH_ENABLED:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
      # Platform credentials
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_OWNER=${GITHUB_OWNER:-}
      - GITHUB_REPO=${GITHUB_REPO:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHANNEL_ID=${TELEGRAM_CHANNEL_ID:-}
      - X_API_KEY=${X_API_KEY:-}
      - X_API_SECRET=${X_API_SECRET:-}
      - X_ACCESS_TOKEN=${X_ACCESS_TOKEN:-}
      - X_ACCESS_SECRET=${X_ACCESS_SECRET:-}
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-}
      - REDDIT_USERNAME=${REDDIT_USERNAME:-}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD:-}
      - REDDIT_SUBREDDIT=${REDDIT_SUBREDDIT:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Community - Monitors and responds to community interactions
  # ============================================================================
  community:
    build:
      context: .
      
    container_name: marketing-community
    command: ["npx", "tsx", "agents/community/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Partnerships - Generates leads and outreach messages
  # ============================================================================
  partnerships:
    build:
      context: .
      
    container_name: marketing-partnerships
    command: ["npx", "tsx", "agents/partnerships/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Analytics - Generates KPI reports from Moltbook data
  # ============================================================================
  analytics:
    build:
      context: .
      
    container_name: marketing-analytics
    command: ["npx", "tsx", "agents/analytics/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

  # ============================================================================
  # Proof - Generates proof packs with verification
  # ============================================================================
  proof:
    build:
      context: .
      
    container_name: marketing-proof
    command: ["npx", "tsx", "agents/proof/index.ts"]
    environment:
      - RUN_ONCE=${RUN_ONCE:-false}
      - WORKSPACE_DIR=/workspace
      - MOLTBOOK_DIR=/moltbook
      - CONFIG_DIR=/config
      - LOGS_DIR=/logs
      - STORE_DB=/workspace/store.db
    volumes:
      - workspace:/workspace
      - moltbook:/moltbook
      - logs:/logs
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - marketing-net
    restart: unless-stopped

networks:
  marketing-net:
    driver: bridge

volumes:
  workspace:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/marketing-ops/workspace
  moltbook:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/marketing-ops/moltbook
  logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/marketing-ops/logs
